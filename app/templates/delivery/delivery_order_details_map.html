{% extends "base.html" %}

{% block title %}Detalles de Entrega: Pedido #{{ order.order_id }} - Skyking{% endblock %}

{% block head_extra %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
    <style>
        .page-padding { padding-top: 20px; padding-bottom: 30px; }
        .card { background-color: #1E1E1E; padding: 20px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); margin-bottom:20px; }
        .card h3 { font-size: 1.3em; color: #00D9C0; margin-bottom: 15px; border-bottom: 1px solid #444; padding-bottom: 10px;}
        .detail-list p { margin-bottom: 0.5rem; font-size: 0.95em; }
        .detail-list strong { color: #ccc; min-width:120px; display: inline-block;}
        #deliveryMap { height: 350px; width: 100%; border-radius: 8px; margin-bottom: 20px; border: 1px solid #333;}
        .actions-repartidor .btn { margin-right:10px; margin-bottom:10px; background-color: #00D9C0; color:#121212; border:none; font-weight:bold;}
        .actions-repartidor .btn-warning { background-color: #ffc107; color:black;}
    </style>
{% endblock %}

{% block content %}
<div class="container page-padding">
    <a href="{{ url_for('delivery.repartidor_dashboard') }}" class="btn btn-outline-secondary mb-3" style="color:#00D9C0; border-color:#00D9C0; text-decoration: none; display: inline-block; padding: 8px 15px; margin-bottom:20px;">&laquo; Volver al Panel</a>

    <h1><i class="fas fa-route"></i> Detalles de Entrega - Pedido #{{ order.order_id }}</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}{% for C, M in messages %}<div class="alert alert-{{C}}" style="background-color: #333; color: #fff; padding: 10px; margin-bottom:15px; border-left: 5px solid ;">{{M}}</div>{% endfor %}{% endif %}
    {% endwith %}

    <div class="row">
        <div class="col-md-7">
            <div class="card">
                <h3><i class="fas fa-map-marked-alt"></i> Mapa de Ruta (Ejemplo)</h3>
                <div id="deliveryMap"></div>
            </div>
        </div>
        <div class="col-md-5">
            <div class="card detail-list">
                <h3><i class="fas fa-store"></i> Punto de Recogida (Restaurante)</h3>
                <p><strong>Nombre:</strong> {{ order.restaurant_name }}</p>
                <p><strong>Dirección:</strong> {{ order.restaurant_address }}</p>
                <p><strong>Teléfono:</strong> {{ order.restaurant_phone | default('N/A') }}</p>
            </div>
            <div class="card detail-list">
                <h3><i class="fas fa-user-alt"></i> Punto de Entrega (Cliente)</h3>
                <p><strong>Nombre:</strong> {{ order.customer_name }}</p>
                <p><strong>Dirección:</strong> {{ order.customer_delivery_address }}</p>
                <p><strong>Teléfono:</strong> {{ order.customer_phone | default('N/A') }}</p>
                <p><strong>Notas del Pedido:</strong> {{ order.order_notes | default('Ninguna') }}</p>
            </div>
        </div>
    </div>

    <div class="card">
        <h3><i class="fas fa-box"></i> Resumen del Pedido</h3>
        <p><strong>Ítems:</strong> {{ order.item_summary | default('No detallados') }}</p>
        <p><strong>Total del Pedido:</strong> ${{ "{:,.2f}".format(order.total_amount | default(0)) }}</p>
        <p><strong>Estado Actual:</strong> <span style="text-transform:capitalize; font-weight:bold;">{{ order.order_status | replace('_', ' ') }}</span></p>
    </div>

    <div class="card actions-repartidor">
        <h3>Acciones de Entrega</h3>
        {# Estos botones son placeholders. Implementaremos su lógica después. #}
        {% if order.order_status == 'confirmed' or order.order_status == 'preparing' %}
            <button class="btn"><i class="fas fa-check-circle"></i> Marcar como Recogido / En Camino</button>
        {% elif order.order_status == 'out_for_delivery' %}
            <button class="btn"><i class="fas fa-people-carry"></i> Marcar como Entregado</button>
        {% endif %}
        <button class="btn btn-warning"><i class="fas fa-exclamation-triangle"></i> Reportar Incidente</button>
    </div>

</div>
{% endblock %}

{% block scripts_extra %}
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
         integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
         crossorigin=""></script>
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- LOGS PARA DEPURAR LOS DATOS QUE LLEGAN DESDE FLASK ---
        console.log("Datos del pedido (order) recibidos por la plantilla:", {{ order | tojson | safe }});
        console.log("Coordenadas de recogida (pickup_coords) recibidas:", {{ pickup_coords | tojson | safe }});
        console.log("Coordenadas de entrega (delivery_coords) recibidas:", {{ delivery_coords | tojson | safe }});

        // Usamos default(0) para asegurar que sean números y evitar errores de sintaxis.
        // El '0' es un valor de fallback si la coordenada no está definida.
        var pickupLat = parseFloat({{ pickup_coords.lat | default(0) }});
        var pickupLon = parseFloat({{ pickup_coords.lon | default(0) }});
        var deliveryLat = parseFloat({{ delivery_coords.lat | default(0) }});
        var deliveryLon = parseFloat({{ delivery_coords.lon | default(0) }});

        console.log("Valores JavaScript - pickupLat:", pickupLat, "pickupLon:", pickupLon);
        console.log("Valores JavaScript - deliveryLat:", deliveryLat, "deliveryLon:", deliveryLon);

        if (typeof L !== 'undefined') { // Verificar que Leaflet haya cargado
            try {
                var map = L.map('deliveryMap');
                
                var midLat, midLon, initialZoom;

                // Si tenemos ambas coordenadas válidas (no 0,0 que es nuestro default)
                if (pickupLat !== 0 || pickupLon !== 0 || deliveryLat !== 0 || deliveryLon !== 0) {
                    // Si solo una es 0,0, centramos en la otra. Si ambas son válidas, centramos en el medio.
                    if (pickupLat === 0 && pickupLon === 0) { // Solo tenemos coords de entrega
                        midLat = deliveryLat;
                        midLon = deliveryLon;
                        initialZoom = 15;
                    } else if (deliveryLat === 0 && deliveryLon === 0) { // Solo tenemos coords de recogida
                        midLat = pickupLat;
                        midLon = deliveryLon; // Corrección: Debería ser pickupLon
                        initialZoom = 15;
                    } else { // Tenemos ambas
                        midLat = (pickupLat + deliveryLat) / 2;
                        midLon = (pickupLon + deliveryLon) / 2;
                        initialZoom = 13; // Un zoom más alejado para ver ambos puntos
                    }
                } else {
                    // Si todas son 0 (o sea, no se pasaron coordenadas reales), centrar en Bucaramanga
                    midLat = 7.1193; 
                    midLon = -73.1228;
                    initialZoom = 14; 
                    console.log("No se proporcionaron coordenadas válidas, usando centro de Bucaramanga por defecto.");
                }
                
                console.log("Centrando mapa en Lat:", midLat, "Lon:", midLon, "Zoom:", initialZoom);
                map.setView([midLat, midLon], initialZoom);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);

                // Marcadores (asegúrate de tener las imágenes en static/images o quita la parte de 'icon')
                // O usa los marcadores por defecto de Leaflet si las imágenes no cargan
                var redIcon = L.icon({ iconUrl: "{{ url_for('static', filename='images/marker-icon-red.png') }}", shadowUrl: "{{ url_for('static', filename='images/marker-shadow.png') }}", iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });
                var greenIcon = L.icon({ iconUrl: "{{ url_for('static', filename='images/marker-icon-green.png') }}", shadowUrl: "{{ url_for('static', filename='images/marker-shadow.png') }}", iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });
                var defaultIcon = L.Icon.Default.prototype.options; // Para restaurar si es necesario


                // Solo añadir marcador de recogida si las coordenadas no son el fallback 0,0
                if (!(pickupLat === 0 && pickupLon === 0)) {
                    L.marker([pickupLat, pickupLon], {icon: redIcon}).addTo(map)
                        .bindPopup('<b>Punto de Recogida:</b><br>{{ order.restaurant_name | e | replace("\'", "\\\'") }}<br>{{ order.restaurant_address | e | replace("\'", "\\\'") }}')
                        .openPopup();
                }

                // Solo añadir marcador de entrega si las coordenadas no son el fallback 0,0
                if (!(deliveryLat === 0 && deliveryLon === 0)) {
                    L.marker([deliveryLat, deliveryLon], {icon: greenIcon}).addTo(map)
                        .bindPopup('<b>Punto de Entrega:</b><br>{{ order.customer_name | e | replace("\'", "\\\'") }}<br>{{ order.customer_delivery_address | e | replace("\'", "\\\'") }}');
                }
                
                // Si ambas coordenadas son válidas y diferentes de 0,0, ajusta el zoom para ver ambas
                if (!(pickupLat === 0 && pickupLon === 0) && !(deliveryLat === 0 && deliveryLon === 0)) {
                    map.fitBounds([ [pickupLat, pickupLon], [deliveryLat, deliveryLon] ], {padding: [50, 50]});
                }

            } catch (mapError) {
                console.error("Error inicializando el mapa Leaflet:", mapError);
                document.getElementById('deliveryMap').innerHTML = '<p style="color:red;text-align:center;">Error al cargar el mapa: ' + mapError.message + '</p>';
            }
        } else {
            console.error("Leaflet (L) no está definido. El mapa no se mostrará.");
            document.getElementById('deliveryMap').innerHTML = '<p style="color:red;text-align:center;">No se pudo cargar la librería del mapa (Leaflet).</p>';
        }
    });
</script>
{% endblock %}