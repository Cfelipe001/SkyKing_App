{% extends "base.html" %}

{% block title %}Gestionar Usuarios - Admin Skyking{% endblock %}

{% block head_extra %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        /* Estilos específicos para esta tabla si son necesarios, o usa los de main_style.css */
        .table th, .table td { vertical-align: middle; }
        .table .btn-sm { padding: .25rem .5rem; font-size: .8rem; }
        .page-padding { padding-top: 30px; padding-bottom: 50px; }
    </style>
{% endblock %}

{% block content %}
<div class="container page-padding">
    <a href="{{ url_for('admin.dashboard') }}" class="btn btn-outline-secondary mb-3" style="color:#00D9C0; border-color:#00D9C0; text-decoration: none; display: inline-block; padding: 8px 15px; margin-bottom:20px;">&laquo; Volver al Panel Admin</a>
    <h1><i class="fas fa-users-cog"></i> Gestionar Usuarios del Sistema</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div style="margin-bottom: 20px;">
            {% for category, message in messages %}
                {% set border_color = '#00D9C0' %} 
                {% if category == 'danger' %}{% set border_color = '#dc3545' %}{% endif %}
                {% if category == 'success' %}{% set border_color = '#28a745' %}{% endif %}
                <div class="alert alert-{{ category if category != 'message' else 'info' }}" role="alert" 
                     style="background-color: #333; color: #fff; padding: 10px; margin-bottom:10px; border-left: 5px solid  border_color;">
                    {{ message }}
                </div>
            {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <div class="mb-3 text-right">
        <a href="{{ url_for('admin.register_new_user_by_admin') }}" class="btn btn-success-custom" style="background-color: #28a745; color:white; border:none; text-decoration: none; padding: 10px 20px; border-radius: 20px; font-weight: 500;">
            <i class="fas fa-user-plus"></i> Registrar Nuevo Usuario
        </a>
    </div>

    {% if users %}
        <div class="card" style="background-color: #1E1E1E; padding: 20px; border-radius: 8px;">
            <h2 style="color: #E0E0E0; font-size: 1.8em; margin-bottom: 15px; border-bottom: 1px solid #444; padding-bottom: 10px;">Lista de Usuarios</h2>
            <table class="table" style="color: #E0E0E0; width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="text-align: left;">
                        <th style="padding: 12px; border-bottom: 2px solid #555; color: #00D9C0;">ID</th>
                        <th style="padding: 12px; border-bottom: 2px solid #555; color: #00D9C0;">Nombre Completo</th>
                        <th style="padding: 12px; border-bottom: 2px solid #555; color: #00D9C0;">Email</th>
                        <th style="padding: 12px; border-bottom: 2px solid #555; color: #00D9C0;">Rol</th>
                        <th style="padding: 12px; border-bottom: 2px solid #555; color: #00D9C0;">Teléfono</th>
                        <th style="padding: 12px; border-bottom: 2px solid #555; color: #00D9C0;">Estado</th>
                        <th style="padding: 12px; border-bottom: 2px solid #555; color: #00D9C0;">Registrado</th>
                        <th style="padding: 12px; border-bottom: 2px solid #555; color: #00D9C0;">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user_item in users %} {# Cambiado 'user' a 'user_item' para evitar conflicto con variable 'user' global si existiera #}
                    <tr style="border-top: 1px solid #444;">
                        <td style="padding: 12px;">{{ user_item.id }}</td>
                        <td style="padding: 12px;">{{ user_item.full_name | default('N/A') }}</td>
                        <td style="padding: 12px;">{{ user_item.email }}</td>
                        <td style="padding: 12px;"><span style="text-transform: capitalize;">{{ user_item.role | replace('_', ' ') }}</span></td>
                        <td style="padding: 12px;">{{ user_item.phone_number | default('N/A') }}</td>
                        <td style="padding: 12px;">
                            {% if user_item.is_active %}
                             <span style="color: #28a745; font-weight:bold;">Activo</span>
                            {% else %}
                             <span style="color: #dc3545; font-weight:bold;">Inactivo</span>
                            {% endif %}
                        </td>
                        <td style="padding: 12px;">
                            {% if user_item.created_at %}
                                {{ user_item.created_at.strftime('%d/%m/%Y') }}
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        <td style="padding: 12px; white-space: nowrap;">
                            <a href="{{ url_for('admin.edit_user_by_admin', user_id=user_item.id) }}" class="btn btn-sm btn-secondary-custom" style="margin-right: 5px; background-color: #5A5A5A; color:white; text-decoration:none; padding: 5px 10px; border-radius:15px; font-size:0.85em;">Editar</a>
                            
                            {% if user_item.is_active %}
                                {% if user_item.id != session.user_id %} {# No mostrar desactivar para el admin actual #}
                                <form action="{{ url_for('admin.deactivate_user_by_admin', user_id=user_item.id) }}" method="POST" style="display: inline;">
                                    <button type="submit" class="btn btn-sm btn-warning" style="background-color: #ffc107; color:black; border:none; padding: 5px 10px; border-radius:15px; font-size:0.85em; cursor:pointer;" 
                                        onclick="return confirm('¿Estás seguro de que quieres DESACTIVAR a este usuario: {{ user_item.email }}? El usuario no podrá iniciar sesión.');">
                                    Desactivar
                                </button>
                                </form>
                                {% endif %}
                            {% else %}
                            <form action="{{ url_for('admin.activate_user_by_admin', user_id=user_item.id) }}" method="POST" style="display: inline;">
                                <button type="submit" class="btn btn-sm btn-success" style="background-color: #28a745; color:white; border:none; padding: 5px 10px; border-radius:15px; font-size:0.85em; cursor:pointer;"
                                        onclick="return confirm('¿Estás seguro de que quieres ACTIVAR a este usuario: {{ user_item.email }}?');">
                                    Activar
                                </button>
                            </form>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="alert alert-info" role="alert" style="background-color: #333; color: #fff; padding: 15px; border-left: 5px solid #17a2b8; border-radius: 4px;">
            No hay usuarios registrados en el sistema (aparte de ti, quizás).
        </div>
    {% endif %}
</div>
{% endblock %}