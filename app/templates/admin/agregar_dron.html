{% extends "base.html" %}

{% block title %}{{ form_action_title | default('Gestionar Dron') }} - Admin Skyking{% endblock %}

{% block head_extra %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        /* Puedes copiar los estilos de .admin-form-card de register_new_user_form.html o edit_user_form.html */
        .admin-form-card { background-color: #1E1E1E; padding: 25px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); width:100%; max-width: 600px; margin: 20px auto; }
        .admin-form-card .form-group { margin-bottom: 18px; text-align: left; }
        .admin-form-card .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #ccc; }
        .admin-form-card .form-group input, 
        .admin-form-card .form-group select { 
            width: 100%; padding: 12px; border: 1px solid #444; 
            border-radius: 4px; box-sizing: border-box; 
            background-color: #2A2A2A; color: #E0E0E0; font-size: 1em; 
        }
        .admin-form-card .form-group input:focus, 
        .admin-form-card .form-group select:focus { 
            outline: none; border-color: #00D9C0; 
            box-shadow: 0 0 0 0.2rem rgba(0,217,192,.25); 
        }
        .admin-form-card .btn-submit-admin { 
            background-color: #00D9C0; color: #121212; border:none; 
            padding: 12px 30px; font-weight: 600; border-radius:25px;
            cursor: pointer; transition: background-color 0.3s ease;
        }
        .admin-form-card .btn-submit-admin:hover { background-color: #00bfa5; }
        .page-padding { padding-top: 30px; padding-bottom: 50px; }
    </style>
{% endblock %}

{% block content %}
<div class="container page-padding">
    {% if is_edit_mode %}
        <a href="{{ url_for('admin.manage_drones_list') }}" class="btn btn-outline-secondary mb-3" style="color:#00D9C0; border-color:#00D9C0; text-decoration: none; display: inline-block; padding: 8px 15px; margin-bottom:20px;">&laquo; Volver a Lista de Drones</a>
    {% else %}
        <a href="{{ url_for('admin.dashboard') }}" class="btn btn-outline-secondary mb-3" style="color:#00D9C0; border-color:#00D9C0; text-decoration: none; display: inline-block; padding: 8px 15px; margin-bottom:20px;">&laquo; Volver al Panel Admin</a>
    {% endif %}

    <h1><i class="fas fa-helicopter"></i> {{ form_action_title | default('Gestionar Dron') }}</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div style="margin-bottom: 20px;">
            {% for category, message in messages %}
                {% set border_color = '#00D9C0' %} 
                {% if category == 'danger' %}{% set border_color = '#dc3545' %}{% endif %}
                {% if category == 'success' %}{% set border_color = '#28a745' %}{% endif %}
                <div class="alert alert-{{ category if category != 'message' else 'info' }}" role="alert" 
                     style="background-color: #333; color: #fff; padding: 10px; margin-bottom:10px; border-left: 5px solid border_color ;">
                    {{ message }}
                </div>
            {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <div class="admin-form-card">
        {# El action del formulario apunta a la ruta actual si es GET, o a la ruta de edición/creación #}
        <form method="POST" 
              action="{{ url_for('admin.edit_drone_by_admin', drone_id=drone_id) if is_edit_mode else url_for('admin.add_new_drone_by_admin') }}">
            
            <div class="form-group">
                <label for="drone_identifier">Identificador del Dron (Ej: SKY001):</label>
                <input type="text" id="drone_identifier" name="drone_identifier" 
                       value="{{ drone.drone_identifier if drone else form_data.get('drone_identifier', '') }}" required>
            </div>

            <div class="form-group">
                <label for="drone_model">Modelo del Dron:</label>
                <input type="text" id="drone_model" name="drone_model" 
                       value="{{ drone.model if drone else form_data.get('drone_model', '') }}" required>
            </div>

            <div class="form-group">
                <label for="purchase_date">Fecha de Adquisición:</label>
                {# Para input type="date", el value debe ser YYYY-MM-DD #}
                {# Asumimos que drone.purchase_date es un objeto date de Python o string YYYY-MM-DD #}
                <input type="date" id="purchase_date" name="purchase_date" 
                       value="{{ (drone.purchase_date.strftime('%Y-%m-%d') if drone and drone.purchase_date else form_data.get('purchase_date', '')) }}">
            </div>

            <div class="form-group">
                <label for="status">Estado Actual:</label>
                <select id="status" name="status" required>
                    {# Determinar la lista de opciones de estado ANTES del bucle #}
                    {% set statuses_to_loop = possible_statuses if possible_statuses else ['activo', 'mantenimiento', 'inactivo', 'de_baja'] %}

                    {% for status_option in statuses_to_loop %}
                    <option value="{{ status_option }}" {% if status_option == current_drone_status %}selected{% endif %}>
                        {{ status_option | replace('_', ' ') | capitalize }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="max_load_capacity_kg">Capacidad Máx. de Carga (kg):</label>
                <input type="number" step="0.01" min="0" id="max_load_capacity_kg" name="max_load_capacity_kg"
                       value="{{ drone.max_load_capacity_kg if drone and drone.max_load_capacity_kg is not none else form_data.get('max_load_capacity_kg', '') }}">
            </div>

            <div class="form-group">
                <label for="max_flight_time_min">Tiempo Máx. de Vuelo (minutos):</label>
                <input type="number" min="0" id="max_flight_time_min" name="max_flight_time_min"
                       value="{{ drone.max_flight_time_min if drone and drone.max_flight_time_min is not none else form_data.get('max_flight_time_min', '') }}">
            </div>
            
            <button type="submit" class="btn-submit-admin">
                {% if is_edit_mode %}Guardar Cambios{% else %}Agregar Dron{% endif %}
            </button>
        </form>
    </div>
</div>
{% endblock %}