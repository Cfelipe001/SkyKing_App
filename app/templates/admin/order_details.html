{% extends "base.html" %}

{% block title %}Detalles del Pedido #{{ order.id }} - Admin Skyking{% endblock %}

{% block head_extra %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        .page-padding { 
            padding-top: 30px; 
            padding-bottom: 50px; 
        }
        .card { 
            background-color: #1E1E1E; 
            padding: 20px 25px; 
            border-radius: 8px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); 
            margin-bottom:25px; 
        }
        .card h2, .card h3 { 
            color: #00D9C0; 
            margin-top: 0; 
            margin-bottom: 15px; 
            border-bottom: 1px solid #444; 
            padding-bottom: 10px;
        }
        .order-details-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 25px; 
        }
        .detail-section p { 
            margin-bottom: 0.6rem; 
            font-size: 0.95em; 
            line-height: 1.6;
        }
        .detail-section p strong { 
            color: #ccc; 
            min-width: 160px; 
            display: inline-block; 
        }
        .items-table { 
            width: 100%; 
            margin-top: 15px; 
            border-collapse: collapse; 
        }
        .items-table th, .items-table td { 
            text-align: left; 
            padding: 10px; 
            border-bottom: 1px solid #333; 
        }
        .items-table th { 
            color: #00D9C0; 
            font-weight: 600; 
        }
        .items-table td.subtotal, .items-table td.total { 
            text-align: right; 
        }
        .order-summary { 
            margin-top: 20px; 
            text-align: right; 
        }
        .order-summary h3 { 
            text-align: right; 
            border-bottom: none; 
            font-size: 1.4em; 
        }
        .assignment-form .form-group { margin-bottom: 1rem; }
        .assignment-form .form-select,
        .assignment-form .form-control
        { 
            width: 100%; padding: .5rem .75rem; 
            font-size: 0.95em; 
            line-height: 1.5;
            color: #E0E0E0; background-color: #2A2A2A;
            background-clip: padding-box; border: 1px solid #444; border-radius: .25rem;
            transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
        }
         .assignment-form .form-select:focus {
            border-color: #00D9C0;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0, 217, 192, 0.25);
        }
        .btn-primary-custom { 
            background-color: #00D9C0; color: #121212; border:none; 
            padding: 10px 25px; font-weight:bold; cursor:pointer;
            border-radius: 20px;
        }
        .btn-primary-custom:hover{ background-color: #00bfa5; }
        .current-assignment p { margin-bottom: 0.5rem; }
        .current-assignment strong { color: #E0E0E0; } 
        .current-assignment .status-pendiente { color: #ffc107; font-weight: bold; }

    </style>
{% endblock %}

{% block content %}
<div class="container page-padding">
    <a href="{{ url_for('admin.view_all_system_orders') }}" class="btn btn-outline-secondary mb-3" style="color:#00D9C0; border-color:#00D9C0; text-decoration: none; display: inline-block; padding: 8px 15px; margin-bottom:20px;">&laquo; Volver a Todos los Pedidos</a>
    
    {# Asumimos que la ruta Flask que renderiza esta plantilla se asegura de que 'order' no sea None. #}
    {# Si 'order' pudiera ser None, necesitarías un {% if order %} aquí. #}
    {# Pero tu ruta view_order_details_by_admin ya hace redirect si order no se encuentra. #}
    <h1><i class="fas fa-receipt"></i> Detalles del Pedido #{{ order.id }}</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                {% set border_color = '#00D9C0' %} 
                {% if category == 'danger' %}{% set border_color = '#dc3545' %}{% endif %}
                {% if category == 'success' %}{% set border_color = '#28a745' %}{% endif %}
                <div class="alert alert-{{ category if category != 'message' else 'info' }}" role="alert" 
                     style="background-color: #333; color: #fff; padding: 10px; margin-bottom:15px; border-left: 5px solid  border_color;">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    {# El bloque principal del contenido del pedido, que depende de que 'order' exista #}
    <div class="card">
        <h2>Información General del Pedido</h2>
        <div class="order-details-grid">
            <div class="detail-section">
                <p><strong>ID Pedido:</strong> #{{ order.id }}</p>
                <p><strong>Fecha del Pedido:</strong> {{ order.ordered_at.strftime('%d/%m/%Y %H:%M:%S') if order.ordered_at else 'N/A' }}</p>
                <p><strong>Estado Actual:</strong> <span style="text-transform: capitalize; font-weight:bold;">{{ order.status | replace('_', ' ') }}</span></p>
            </div>
            <div class="detail-section">
                <p><strong>Tipo de Entrega:</strong> {{ order.delivery_type | replace('_', ' ') | capitalize if order.delivery_type else 'N/A' }}</p>
                <p><strong>Método de Pago:</strong> {{ order.payment_method | replace('_', ' ') | capitalize if order.payment_method else 'N/A' }}</p>
                <p><strong>Estado del Pago:</strong> {{ order.payment_status | replace('_', ' ') | capitalize if order.payment_status else 'N/A' }}</p>
            </div>
            <div class="detail-section" style="grid-column: span 2;">
                <p><strong>Dirección de Entrega:</strong> {{ order.delivery_address | default('N/A') }}</p>
                <p><strong>Instrucciones/Notas:</strong> {{ order.delivery_instructions | default('Ninguna') }}</p>
            </div>
        </div>
    </div>

    <div class="order-details-grid">
        <div class="card detail-section">
            <h3><i class="fas fa-user"></i> Cliente</h3>
            <p><strong>Nombre:</strong> {{ order.customer_name | default('N/A') }}</p>
            <p><strong>Email:</strong> {{ order.customer_email | default('N/A') }}</p>
            <p><strong>Teléfono:</strong> {{ order.customer_phone | default('N/A') }}</p>
        </div>

        <div class="card detail-section">
            <h3><i class="fas fa-store"></i> Restaurante</h3>
            <p><strong>Nombre:</strong> {{ order.restaurant_name | default('N/A') }}</p>
            <p><strong>Dirección:</strong> {{ order.restaurant_address | default('N/A') }}</p>
            <p><strong>Teléfono:</strong> {{ order.restaurant_phone | default('N/A') }}</p>
        </div>
    </div>

    <div class="card">
        <h3><i class="fas fa-shipping-fast"></i> Asignación de Entrega</h3>
        <div class="current-assignment mb-3">
            <p><strong>Tipo de Entrega Solicitado:</strong> <span style="text-transform: capitalize;">{{ order.delivery_type | replace('_', ' ') }}</span></p>
            {% if order.delivery_type == 'drone' %}
                {% if order.assigned_drone_id %}
                    <p><strong>Asignado a Dron:</strong> {{ order.assigned_drone_identifier | default('ID: ' ~ order.assigned_drone_id|string) }} ({{ order.assigned_drone_model | default('Modelo desc.') }})</p>
                {% else %}
                    <p><strong>Asignado a Dron:</strong> <span class="status-pendiente">Pendiente de Asignación</span></p>
                {% endif %}
            {% elif order.delivery_type in ['motorcycle', 'bicycle'] %}
                {% if order.delivery_person_id %}
                    <p><strong>Asignado a Repartidor:</strong> {{ order.delivery_person_name | default('ID: ' ~ order.delivery_person_id|string) }} (Tel: {{ order.delivery_person_phone | default('N/A') }})</p>
                {% else %}
                    <p><strong>Asignado a Repartidor:</strong> <span class="status-pendiente">Pendiente de Asignación</span></p>
                {% endif %}
            {% else %}
                <p><small>Este tipo de entrega no requiere asignación o es desconocido.</small></p>
            {% endif %}
        </div>

        {% if assignable_entities and order.delivery_type in ['drone', 'motorcycle', 'bicycle'] %}
        <form method="POST" action="{{ url_for('admin.assign_delivery_handler', order_id=order.id) }}" class="assignment-form">
            <div class="form-group">
                <label for="delivery_entity_id">
                    {% if entity_type_for_assignment == 'drone' %}
                        Reasignar/Asignar Dron Disponible:
                    {% elif entity_type_for_assignment == 'person' %}
                        Reasignar/Asignar Repartidor Disponible ({{ order.delivery_type | replace('_', ' ') | capitalize }}):
                    {% endif %}
                </label>
                <select name="delivery_entity_id" id="delivery_entity_id" class="form-select" required>
                    <option value="" disabled selected>-- Elige una opción --</option>
                    <option value="0">-- Desasignar --</option> 
                    {% for entity in assignable_entities %}
                        {% if entity_type_for_assignment == 'drone' %}
                            <option value="{{ entity.id }}" 
                                    {% if order.assigned_drone_id == entity.id %}selected{% endif %}>
                                {{ entity.drone_identifier }} ({{ entity.model }})
                            </option>
                        {% elif entity_type_for_assignment == 'person' %}
                            <option value="{{ entity.id }}"
                                    {% if order.delivery_person_id == entity.id %}selected{% endif %}>
                                {{ entity.full_name }} ({{ entity.email }})
                            </option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            
            <input type="hidden" name="entity_type_for_assignment" value="{{ entity_type_for_assignment }}">
            
            <div class="form-group">
                <label for="new_order_status_on_assign">Cambiar estado del pedido a (opcional):</label>
                <select name="new_order_status" id="new_order_status_on_assign" class="form-select">
                    <option value="">-- No cambiar estado --</option>
                    {% set statuses_for_assignment = ['confirmed', 'preparing', 'out_for_delivery'] %}
                    {% for status_val in statuses_for_assignment %}
                        <option value="{{ status_val }}">{{ status_val | replace('_', ' ') | capitalize }}</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn btn-primary-custom">Actualizar Asignación</button>
        </form>
        {% elif order.delivery_type in ['drone', 'motorcycle', 'bicycle'] %}
            <p style="color: #ffc107;">No hay {{ 'drones' if order.delivery_type == 'drone' else 'repartidores' }} disponibles o configurados para asignación en este momento para este tipo de entrega.</p>
        {% endif %}
    </div>

    <div class="card"> 
        <h3><i class="fas fa-shopping-basket"></i> Ítems del Pedido</h3>
        {% if order.items %} {# Se asume que la ruta pasa 'order' que contiene una lista 'items' #}
            <table class="items-table">
                <thead>
                    <tr>
                        <th>Ítem</th>
                        <th>Descripción</th>
                        <th>Precio Unit. Pagado</th>
                        <th>Cantidad</th>
                        <th class="subtotal">Subtotal</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in order.get('items', []) %}
                    <tr>
                        <td>{{ item.item_name | default('Nombre no disponible') }}</td>
                        <td>{{ item.item_description | truncate(80) | default('N/A') }}</td>
                        <td>${{ "{:,.2f}".format(item.item_unit_price | default(0.00)) }}</td>
                        <td>{{ item.quantity | default(0) }}</td>
                        <td class="subtotal">${{ "{:,.2f}".format(item.item_subtotal | default(0.00)) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="4" style="text-align:right; font-weight:bold; padding-top:15px;">TOTAL DEL PEDIDO:</td>
                        <td class="total" style="font-weight:bold; font-size:1.2em; padding-top:15px;">${{ "{:,.2f}".format(order.total_amount | default(0.00)) }}</td>
                    </tr>
                </tfoot>
            </table>
        {% else %}
            <p>No se encontraron ítems para este pedido.</p>
        {% endif %}
    </div>
    
</div>
{% endblock %}